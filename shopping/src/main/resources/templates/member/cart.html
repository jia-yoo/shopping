<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<style>
img{
	width:100px;
	height:100px;
}
input{
	width:10px;
}
</style>
</head>
<body>
<header>
	<nav>
		<a href="/"><img id="logo" style="width:50px; height:50px;" src="/img/logo.jpg"></a>
		<a href="/user/shop">shop</a>
		<div class="cart-wrap" onclick="location.href='/member/cart'">
			<div class="cart-image">
				<img style="width:50px; height:50px;" src="/img/shopping_cart.png">
			</div>
			<div  class="cart-text">
				<span>0</span>
			</div>
		</div>
		<th:block th:if="${session.id == null}">
			<a href="/member/mem_regForm">íšŒì›ê°€ì…í•˜ê¸°</a>
			<a href="/member/login">ë¡œê·¸ì¸í•˜ê¸°</a>
		</th:block>
		<th:block th:if="${session.id != null}">
			<span>[[${session.id}]] ë‹˜ ì–´ì„œì˜¤ì„¸ìš” ğŸ˜‰<span>
			<a href="/member/logout">ë¡œê·¸ì•„ì›ƒí•˜ê¸°</a>
			<a href="/member/myPage">ë§ˆì´í˜ì´ì§€</a>
		</th:block>
		<a href="/admin/admin_main">ê´€ë¦¬ìí˜ì´ì§€ë¡œê°€ê¸°</a>
	</nav>
</header>
<main>
	<h1>cart í™”ë©´</h1>
		<table>
			<tr>
				<th>check All <input id="checkAll" type="checkbox"></th>
				<th>ìƒí’ˆ ì‚¬ì§„</th>
				<th>ìƒí’ˆëª…</th>
				<th>ìƒí’ˆ ìˆ˜ëŸ‰</th>
				<th>ìƒí’ˆ ê°€ê²©</th>
				<th>ì´ ê°€ê²©</th>
				<th>ì‚­ì œ</th>
			</tr>
			<tr th:each="cartList : ${cartList}">
				<td><input class="checkBox" type="checkbox"></td>
				<td><img th:src="@{|/images/user/${cartList.product.fileName}|}"></td>
				<td>[[${cartList.product.pName}]]</td>
				<td>
					<span style="display:none;" id="dec">â—€</span>
					<span class="orderQuan" th:text="${cartList.cQuan}">0</span>
					<span style="display:none;" id="inc">â–¶</span>
					<button class="changeQuanBtn">ìˆ˜ëŸ‰ë³€ê²½</button>
				</td>
				<td>[[${cartList.product.pPrice}]]</td>
				<td ><input id="pno" style="display:none;" type="text" name="pno" th:value="${cartList.product.pno}"></td>
				<td th:text="${#numbers.formatInteger(cartList.cQuan * cartList.product.pPrice, 0)}"></td>
				<td class="deleteBtns">âŒ</td>
			</tr>
		</table>
		<button onclick="goToOrder()">ì£¼ë¬¸í•˜ê¸°</button>
</main>

<script th:inline="javascript">



const checkAll = document.querySelector("#checkAll");
const deleteBtns = document.querySelectorAll(".deleteBtns");
const checkBoxes = document.querySelectorAll(".checkBox");
const changeQuanBtns = document.querySelectorAll(".changeQuanBtn");

//ìˆ˜ëŸ‰ ë³€ê²½í•˜ê¸°
changeQuanBtns.forEach(btn=>{
	btn.addEventListener("click", function(e){
		const decBtn = e.target.parentElement.querySelector("#dec");     
	    const incBtn = e.target.parentElement.querySelector("#inc");   
		const quan = e.target.parentElement.querySelector(".orderQuan");
	    const currentQuan = quan.textContent;
	    
	    
	    if (btn.dataset.state === "editing") {
            // ì´ë¯¸ ìˆ˜ì •ì¤‘ì¼ë•ŒëŠ” ë³€ê²½ëœ ìˆ˜ëŸ‰ì„ ì €ì¥
            const input = e.target.parentElement.querySelector("input[name='sQuan']");
            const newQuan = input.value;
            quan.textContent = newQuan;

            // í™”ì‚´í‘œë²„íŠ¼ ìˆ¨ê¸°ê¸°
            decBtn.style.display = "none";
            incBtn.style.display = "none";

            // í™•ì¸ë²„íŠ¼ì„ ë‹¤ì‹œ ìˆ˜ëŸ‰ë³€ê²½ìœ¼ë¡œ ë°”ê¿”ì£¼ê¸° + viewingìœ¼ë¡œ ìƒíƒœë°”ê¿”ì£¼ê¸°
            btn.textContent = "ìˆ˜ëŸ‰ë³€ê²½";
            btn.dataset.state = "viewing";
        } else {
          	//viewingìƒíƒœì¼ë•ŒëŠ” ìˆ˜ì •í•  ìˆ˜ ìˆë„ë¡ ë°”ê¿”ì£¼ê¸°

            // ìˆ˜ëŸ‰ì¹¸ inputìœ¼ë¡œ ë°”ê¿”ì£¼ê¸°
    	    quan.innerHTML = "<input type='text' name='sQuan' value='"+ currentQuan + "'>";

            // í™”ì‚´í‘œë²„íŠ¼ë³´ì´ê¸°
            decBtn.style.display = "inline";
            incBtn.style.display = "inline";

            // í™•ì¸ë²„íŠ¼ì„ ë‹¤ì‹œ ìˆ˜ëŸ‰ë³€ê²½ìœ¼ë¡œ ë°”ê¿”ì£¼ê³  + editingìœ¼ë¡œ ìƒíƒœë°”ê¿”ì£¼ê¸°
            btn.textContent = "í™•ì¸";
            btn.dataset.state = "editing";
            
            
          //í´ë¦­ìœ¼ë¡œ ìˆ˜ëŸ‰ë°”ê¿”ì£¼ëŠ” ë²„íŠ¼ 
            decBtn.addEventListener("click", function(e){
    				console.log(e.target.parentElement.querySelector("input").value)
    				let orderQuan = Number(e.target.parentElement.querySelector("input").value);
    				orderQuan--;
    				if(orderQuan > 0){
    					e.target.parentElement.querySelector("input").value = orderQuan;
    				}
    			})
            incBtn.addEventListener("click", function(e){
    				let orderQuan = Number(e.target.parentElement.querySelector("input").value);
    				orderQuan++;
    				if(orderQuan > 1){
    					e.target.parentElement.querySelector("input").value = orderQuan;
    				}
    			}) 
        }
	})
})

deleteBtns.forEach(btn=>{
	btn.addEventListener("click", function(e){
	let pno = e.target.parentElement.querySelector("#pno").innerText;
	location.href="/member/deleteFromCart?pno="+pno;
	})
})
checkAll.addEventListener("click", function(e){
	 const allChecked = Array.from(checkBoxes).every(box => box.checked);
	  checkBoxes.forEach(box => {
	        box.checked = !allChecked;
	    });
	
})
checkBoxes.forEach(box => {
    box.addEventListener('click', function() {
        if (!this.checked) {
            checkAll.checked = false;
        } else if (Array.from(checkBoxes).every(box => box.checked)) {
            checkAll.checked = true;
        }
    });
});

function goToOrder(){
	const selectedItems = [];

    checkBoxes.forEach(box => {
        if (box.checked) {
            const pno = box.dataset.pno;
            const quan = box.parentElement.parentElement.querySelector(".orderQuan").textContent;
            selectedItems.push({ pno: pno, quan: quan });
        }
    });

    const data = JSON.stringify(selectedItems);

    fetch("/member/prod_orderFromCart", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: data
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        throw new Error("Network response was not ok.");
    })
    .then(data => {
        console.log(data);
        // ì„±ê³µì ìœ¼ë¡œ ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆì„ ë•Œ ì¶”ê°€ ì‘ì—…ì„ ì—¬ê¸°ì— ì‘ì„±
//         location.href = "/member/orderConfirmation";
    })
    .catch(error => {
        console.error("There was a problem with the fetch operation:", error);
    });
}

</script>

</body>
</html>