<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Flaky filo - í”Œë ˆí‚¤í•„ë¡œ</title>
<link rel="stylesheet" type="text/css" href="/css/styles.css">
<style>
img{
	width:500px;
	height:500px;
	margin-right:100px;
}
.title{
	color: #335E3B;
	font-size:xx-large;
	font-weight:bolder;
	margin:100px auto;
}
.container{
	width:1800px;
	display:flex;
	justify-content:center;
	margin:20px auto;
}
table th, td {
	border-bottom:1px solid #335E3B; 
	margin-right: 10px;
}
input{
	padding:10px;
	width:500px;
}
.review_write{
	margin:80px auto;
}

#reviewContainer{
	width:1000px;
	border-bottom:1px solid #335E3B;
	margin:10px auto;
}
#reviewContainer li{
	display:flex;
	padding:10px;
	justify-content: space-between;
}
.review{
margin-bottom:300px;
}
#inc, #dec{
	padding:3px;
}
</style>
</head>
<body>
<div th:replace="~{/fragments/fragment-header.html :: fragment-nav}"></div>
<main>
	<h1 class="title">ìƒí’ˆ ìƒì„¸ í˜ì´ì§€</h1>
	<div class="container">
		<img th:src="@{|/images/user/${prod.fileName}|}">
		<table>
			<tr>
				<th>ìƒí’ˆëª…</th>
				<td>[[${prod.pName}]]</td>
			</tr>
			<tr>
				<th>ìƒí’ˆ ê°€ê²©</th>
				<td>[[${prod.pPrice}]]</td>
			</tr>
			<tr>
				<th>ìƒíƒœ (íŒë§¤/í’ˆì ˆ)</th>
				<td th:if="${prod.status == 'onStock'}">íŒë§¤ì¤‘</td>
				<td th:if="${prod.status == 'soldout'}">ì¼ì‹œí’ˆì ˆ</td>
			</tr>
			<tr>
				<th>ìƒí’ˆ ìƒì„¸ ì„¤ëª…</th>
				<td>[[${prod.description}]]</td>
			</tr>
			<tr>
			 <td colspan='2'>ìˆ˜ëŸ‰ : <button id="dec">â—€</button><span id="orderQuan">1</span><button id="inc">â–¶</button></td>
			</tr>
			<tr>
			 <td colspan='2'>
				<div class="orderContainer">
				<button id="addToCartBtn" onclick=''>ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸°</button>
				<button id="goToOrderBtn" onclick=''>ì£¼ë¬¸í•˜ê¸°</button>
			</div>
			</td>
			</tr>
			
		</table>
	</div>	
	
	<div class="review">
	<div class="review_write">
		<input id="content" type="text" name="content" placeholder="ë¦¬ë·°ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš” b(ï¿£â–½ï¿£)d">
		<button onclick="regReview(event)"> ë¦¬ë·°ë“±ë¡í•˜ê¸° </button>
	</div>
	<div class="review_list">
		<ul id="reviewContainer" th:if="${review != null}" th:each="review : ${review}">
			<li><span>[[${review.content}]]</span> <span class="writer">[[${review.member.userName}]] <span th:if="${review.actualPurchase == 1}">  âœ…</span></span> </li>
		</ul>
	</div>
	</div>
</main>
<script th:inline="javascript">

const decBtn = document.querySelector("#dec");
const incBtn = document.querySelector("#inc");
const orderQuanEl = document.querySelector("#orderQuan");
const addToCartBtn = document.querySelector("#addToCartBtn");
const goToOrderBtn = document.querySelector("#goToOrderBtn");
const orderContainer = document.querySelector(".orderContainer");
const reviewContainer = document.querySelector("#reviewContainer");
const pno = [[${prod.pno}]];
const status = [[${prod.status}]];
const cartQuanEl = document.querySelector("#cartQuan");

decBtn.addEventListener("click", function(e){
	let orderQuan = Number(orderQuanEl.innerText);
	orderQuan--;
	if(orderQuan > 0){
		orderQuanEl.innerHTML = orderQuan;
	}
})
incBtn.addEventListener("click", function(e){
	let orderQuan = Number(orderQuanEl.innerText);
	orderQuan++;
	if(orderQuan > 1){
		orderQuanEl.innerHTML = orderQuan;
	}
})
goToOrderBtn.addEventListener("click", function(){
	if(confirm("ì •ë§ë¡œ ì£¼ë¬¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
		let orderQuan = Number(orderQuanEl.innerText);
			  
		  fetch("/member/prod_order?pno="+pno+"&&sQuan="+orderQuan, {
		        method: "POST",
		        headers: {
		            "Content-Type": "application/json"
		        }
		    })
		    .then(response => {
		        if (response.ok) {
		            return response.json();
		        }
		        throw new Error("Network response was not ok.");
		    })
		    .then(data => {
		        
		        // ì„±ê³µì ìœ¼ë¡œ ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆì„ ë•Œ
		        if(data == true){
		        	alert("ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
		        }else {
		        	alert("ì£¼ë¬¸í•˜ë ¤ëŠ” ìƒí’ˆì˜ ìˆ˜ëŸ‰ì´ ì¬ê³ ìˆ˜ëŸ‰( "+ data +" ê°œ)ë³´ë‹¤ ë§ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”");
		        }
		    })
		    .catch(error => {
		        console.error("There was a problem with the fetch operation:", error);
		    });
	}
})


//ìƒíƒœê°€ í’ˆì ˆì¼ê²½ìš° ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸° í˜¹ì€ ì£¼ë¬¸í•˜ê¸° ë²„íŠ¼ì´ ì•ˆë³´ì´ê²Œ ì²˜ë¦¬
if(status == "soldout"){
	goToOrderBtn.style.display="none";
	addToCartBtn.style.display="none";
	orderContainer.innerHTML="<span style='color:red;'>ì´ ìƒí’ˆì€ í˜„ì¬ ì¼ì‹œ í’ˆì ˆë¡œ, ì£¼ë¬¸ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.</span>";
}


addToCartBtn.addEventListener("click", function(){
	//ì¥ë°”êµ¬ë‹ˆì— ì•„ì´í…œë‹´ì•„ì£¼ê¸°
	let orderQuan = Number(orderQuanEl.innerText);
	 const xhttp = new XMLHttpRequest();
	  xhttp.onload = function() {
	    if(this.responseText == "true"){
	    	alert("ìƒí’ˆì´ ì„±ê³µì ìœ¼ë¡œ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¼ìŠµë‹ˆë‹¤.");
	    }else{
	    	alert("ìƒí’ˆì„ ì¥ë°”êµ¬ë‹ˆì— ë‹´ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”ğŸ˜¥");
	    }
	  }
	  xhttp.open("post", "/member/addToCart?pno="+pno+"&&sQuan="+orderQuan, true);
	  xhttp.send();
	
})

function regReview(){
	const content = document.querySelector("#content");
	location.href="/member/reg_review?pno="+pno+"&&content="+content.value;
}

</script>
</body>
</html>