<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="stylesheet" type="text/css" href="/css/styles.css">
</head>
<body>
<header>
	<nav>
		<a href="/"><img id="logo" style="width:50px; height:50px;" src="/img/logo.jpg"></a>
		<a href="/user/shop">shop</a>
		<div class="cart-wrap" onclick="location.href='/member/cart'">
			<div class="cart-image">
				<img style="width:50px; height:50px;" src="/img/shopping_cart.png">
			</div>
			<div  class="cart-text">
				<span>0</span>
			</div>
		</div>
		<th:block th:if="${session.id == null}">
			<a href="/member/mem_regForm">회원가입하기</a>
			<a href="/member/login">로그인하기</a>
		</th:block>
		<th:block th:if="${session.id != null}">
			<span>[[${session.id}]] 님 어서오세요 😉<span>
			<a href="/member/logout">로그아웃하기</a>
			<a href="/member/myPage">마이페이지</a>
		</th:block>
		<a href="/admin/admin_main">관리자페이지로가기</a>
	</nav>
</header>
<main>
	<h1>상품상세페이지 유저</h1>
	<table>
	    <tr>
		    <td colspan="2" th:if="${prod.fileName != null}">
				<img th:src="@{|/images/user/${prod.fileName}|}">
			</td>
			 <td colspan="2" th:if="${prod.fileName == null}">
				이미지 없음
			</td>
		</tr>
		<tr>
			<th>상품명</th>
			<td>[[${prod.pName}]]</td>
		</tr>
		<tr>
			<th>상품 가격</th>
			<td>[[${prod.pPrice}]]</td>
		</tr>
		<tr>
			<th>현 재고수량</th>
			<td>[[${prod.pQuan}]]</td>
		</tr>
		<tr>
			<th>상태 (판매/품절)</th>
			<td th:if="${prod.status == 'onStock'}">판매중</td>
			<td th:if="${prod.status == 'soldout'}">일시품절</td>
		</tr>
		<tr>
			<th>상품 상세 설명</th>
			<td>[[${prod.description}]]</td>
		</tr>
	</table>
	
	<span id="dec">◀</span><span id="orderQuan">1</span><span id="inc">▶</span>
	<div class="orderContainer">
		<button id="addToCartBtn" onclick=''>장바구니에 담기</button>
		<button id="goToOrderBtn" onclick=''>주문하기</button>
	</div>
	<div class="review">
		<ul th:if="${review != null}" th:each="review : ${review}">
			<li></li>
		</ul>
	</div>
</main>
<script th:inline="javascript">

const decBtn = document.querySelector("#dec");
const incBtn = document.querySelector("#inc");
const orderQuanEl = document.querySelector("#orderQuan");
const addToCartBtn = document.querySelector("#addToCartBtn");
const goToOrderBtn = document.querySelector("#goToOrderBtn");
const orderContainer = document.querySelector(".orderContainer");
const pno = [[${prod.pno}]];
const status = [[${prod.status}]];
const cartQuanEl = document.querySelector("#cartQuan");

decBtn.addEventListener("click", function(e){
	let orderQuan = Number(orderQuanEl.innerText);
	orderQuan--;
	if(orderQuan > 0){
		orderQuanEl.innerHTML = orderQuan;
	}
})
incBtn.addEventListener("click", function(e){
	let orderQuan = Number(orderQuanEl.innerText);
	orderQuan++;
	if(orderQuan > 1){
		orderQuanEl.innerHTML = orderQuan;
	}
})
goToOrderBtn.addEventListener("click", function(){
	if(confirm("정말로 주문하시겠습니까?")){
		let orderQuan = Number(orderQuanEl.innerText);
		 const xhttp = new XMLHttpRequest();
		  xhttp.onload = function() {
		    if(this.responseText == "true"){
		    	alert("주문이 성공적으로 완료되었습니다.");
		    }else{
		    	alert("주문에 실패하였습니다. 다시 시도해주세요😥");
		    }
		    }
		  xhttp.open("post", "/member/prod_order?pno="+pno+"&&sQuan="+orderQuan, true);
		  xhttp.send();
	}
})


//상태가 품절일경우 장바구니에 담기 혹은 주문하기 버튼이 안보이게 처리
if(status == "soldout"){
	goToOrderBtn.style.display="none";
	addToCartBtn.style.display="none";
	orderContainer.innerHTML="이 상품은 현재 일시 품절로, 주문이 불가합니다.";
}


addToCartBtn.addEventListener("click", function(){
	//장바구니에 아이템담아주기
	let orderQuan = Number(orderQuanEl.innerText);
	 const xhttp = new XMLHttpRequest();
	  xhttp.onload = function() {
	    if(this.responseText == "true"){
	    	alert("상품이 성공적으로 장바구니에 담겼습니다.");
	    }else{
	    	alert("상품을 장바구니에 담을 수 없습니다. 다시 시도해주세요😥");
	    }
	  }
	  xhttp.open("post", "/member/addToCart?pno="+pno+"&&sQuan="+orderQuan, true);
	  xhttp.send();
	
})

</script>
</body>
</html>